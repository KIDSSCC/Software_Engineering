<html>

<head>
    <title>Take Exam</title>
    <link rel="stylesheet" href="/static/take_exams.css" type="text/css" />
    <link rel="stylesheet" href="/static/exam.css" type="text/css" />
    <link rel="stylesheet" href="/static/answer_area.css" type="text/css" />
    <link rel="stylesheet" href="/static/left_button.css" type="text/css" />
    <script src="/static/easyui/jquery.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="../static/take_exams.css" type="text/css" />
    <link rel="stylesheet" href="../static/exam.css" type="text/css" />
    <link rel="stylesheet" href="../static/answer_area.css" type="text/css" />
    <link rel="stylesheet" href="../static/left_button.css" type="text/css" />
    <script src="../static/easyui/jquery.min.js" type="text/javascript"></script>
</head>

<body class="body">
    <div class="cbl">
        <div class="cblcenter">
            <div class="sign">
                <em>教师主页</em>
            </div>

            <div class="nav_con">
                <button id="info">个人信息</button>
                <button id="exam_manage">题库管理</button>
                <button id="commit">提交</button>
            </div>

        </div>
        <div class="copyright">©2023 南开大学 软件工程</div>
    </div>


    <div class="content" style="padding-left: 40px;">
       
        {% if all_subject %}
            <!-- 如果all_choice不为空，才显示标题 -->
            <div class="tittlebar" style="margin-top: 20px;">
                <!-- ⅡⅢⅣ -->
                <span class="part-name">Part Ⅱ &emsp; 主观作答题</span>
                <div class="line" style="margin-bottom: 10px;"></div>
            </div>
        {% endif %}
        {% for question in all_subject %}
        <div class="question_S">
            <input type="text" name="id" style="display: none;" value="{{question.ID}}">
            <input type="text" name="score" style="display: none;" value="{{question.score}}">
            <input type="text" name="stem" style="display: none;" value="{{question.question_stem}}">
            <span class="directions">
                {{question.ID}}. ({{question.score}}分)
            </span>
                {{question.question_stem}}
            <span style="font-weight: bold;">

            </span>
            <textarea id="correct_input"  form="sending" class="input-text"placeholder="Write down some amazing sentences."></textarea>
        </div>
        {% endfor %}
    </div>
</body>


<script>
    // 提交试卷
    const commit_Button = document.getElementById('commit');
    // 监听按钮的点击事件
    commit_Button.addEventListener('click', function() {
        // 先计算一下客观题的总分
        const questionContainers_C = document.getElementsByClassName('question'); 
        const questionContainers_S = document.getElementsByClassName('question_S');
        let question_num=questionContainers_C.length+questionContainers_S.length;
        const formData = new FormData();
        let choice_score=0;
        for (let i = 0; i < questionContainers_C.length; i++)
        {
            let result=''
            const questionContainer = questionContainers_C[i];
            //获取ID
            var questionID = questionContainer.querySelector('input[name="id"]');
            var ID = questionID.value;
            result+='选择题编号:'+ID+'\n';
            //获取答案
            var answerInput = questionContainer.querySelector('input[name="answer"]');
            var answer = answerInput.value;
            result+='标准答案:'+answer+'\n';
            // 获取 score 值
            var scoreInput = questionContainer.querySelector('input[name="score"]');
            var score = scoreInput.value;
            // 获取选中的复选框值
            var options = questionContainer.querySelectorAll('input[name="option"]');
            var selectedOptions = [];
  
            for (var j = 0; j < options.length; j++) {
                var option = options[j];
    
                if (option.checked) {
                    selectedOptions.push(option.value);
                }
            }
            result+='选择答案:'+selectedOptions[0]+'\n';
            if (selectedOptions[0] ==answer)
            {
                choice_score=choice_score+parseInt(score)
            }
            formData.append('选择题'+ID+'概述',result)
        }
        formData.append('客观题总分', choice_score);
        for (let i = 0; i < questionContainers_S.length; i++)
        {
            let result='';
            const essayContainer = questionContainers_S[i];
            //获取主观题ID
            var questionID = essayContainer.querySelector('input[name="id"]');
            var ID=questionID.value
            result+='主观题编号:'+ID+'\n';
            //获取主观题分数
            var scoreInput = essayContainer.querySelector('input[name="score"]');
            var score = scoreInput.value;
            result+='主观题分数:'+score+'\n';
            //获取主观题题干内容
            var queationStem = essayContainer.querySelector('input[name="stem"]');
            var stem = queationStem.value;
            result+='主观题题干:'+stem+'\n';
            // 获取主观题答案内容
            const textarea = essayContainer.querySelector('textarea');
            const essayQuestionValue = textarea.value;
            result+='主观题答案:'+essayQuestionValue+'\n';
            formData.append('主观题'+ID+'概述',result)

        }
        
        var curr_date = new Date();
        var year = curr_date.getFullYear();
        var month = (curr_date.getMonth() + 1).toString().padStart(2, '0');
        var day = curr_date.getDate().toString().padStart(2, '0');
        var hours = curr_date.getHours().toString().padStart(2, '0');
        var minutes = curr_date.getMinutes().toString().padStart(2, '0');
        var seconds = curr_date.getSeconds().toString().padStart(2, '0');

        var datetimeString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        formData.append('提交时间',datetimeString);
        fetch('/student/take_exams/settle', {
            method: 'POST',
            body: formData
        })
        .then(Response =>{
            window.location.href = "{{url_for('report_card')}}";
        })
    });
</script>
</html>